openapi: 3.1.0
info:
  title: Youtube2Text API
  version: 0.26.0
  description: |
    Minimal local HTTP API for Youtube2Text.
    Notes:
    - CLI remains the primary workflow; API/Web are shells around the same core.
    - SSE endpoints are documented as text/event-stream.
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
servers:
  - url: http://127.0.0.1:8787
security:
  - ApiKeyAuth: []
paths:
  /metrics:
    get:
      operationId: getMetrics
      summary: Get Prometheus metrics
      description: |
        Returns Prometheus exposition format (text/plain; version=0.0.4).
      responses:
        "200":
          description: OK
          content:
            text/plain:
              schema:
                type: string
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /maintenance/cleanup:
    post:
      operationId: triggerMaintenanceCleanup
      summary: Trigger retention cleanup (runs + audio cache)
      description: |
        Runs best-effort retention cleanup based on environment configuration.
        Notes:
        - Never deletes transcripts under `output/<channelDir>/...`.
        - Deletes only API run persistence under `output/_runs/*` (if enabled) and old audio cache files under `audio/*`.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CleanupResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /settings:
    get:
      operationId: getSettings
      summary: Get non-secret settings
      description: |
        Returns the current persisted non-secret defaults stored in `output/_settings.json`,
        and the effective config values after applying those settings to the loaded config.
        Notes:
        - Secrets are never returned here (e.g. `ASSEMBLYAI_API_KEY`, `Y2T_API_KEY`).
        - Precedence: `output/_settings.json` (lowest) < `config.yaml` < `.env` (highest).
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SettingsGetResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    patch:
      operationId: patchSettings
      summary: Update non-secret settings
      description: |
        Updates persisted non-secret defaults in `output/_settings.json`.
        Send `null` for a key to clear it (remove it from the settings file).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SettingsPatchRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SettingsGetResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /watchlist:
    get:
      operationId: listWatchlist
      summary: List watchlist entries
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WatchlistListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      operationId: addWatchlistEntry
      summary: Add watchlist entry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WatchlistCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WatchlistEntryResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /watchlist/{id}:
    get:
      operationId: getWatchlistEntry
      summary: Get watchlist entry
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WatchlistEntryResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    patch:
      operationId: updateWatchlistEntry
      summary: Update watchlist entry
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WatchlistUpdateRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WatchlistEntryResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"
    delete:
      operationId: removeWatchlistEntry
      summary: Remove watchlist entry
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OkResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /scheduler/status:
    get:
      operationId: getSchedulerStatus
      summary: Get scheduler status
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchedulerStatusResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /scheduler/start:
    post:
      operationId: startScheduler
      summary: Start scheduler loop (in-process)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchedulerStatusResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /scheduler/stop:
    post:
      operationId: stopScheduler
      summary: Stop scheduler loop (in-process)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchedulerStatusResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /scheduler/trigger:
    post:
      operationId: triggerSchedulerOnce
      summary: Trigger one scheduler check cycle
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchedulerTriggerResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /events:
    get:
      operationId: streamGlobalEvents
      summary: Stream global events (SSE)
      description: |
        Server-Sent Events stream for global run updates. Event names include:
        - run:created
        - run:updated
        Data is JSON: { type, run, timestamp }.
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /health:
    get:
      operationId: getHealth
      summary: Health check
      security: []
      parameters:
        - name: deep
          in: query
          required: false
          schema: { type: boolean }
          description: When true, returns a best-effort deep health check (deps + disk + persistence).
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /runs:
    get:
      operationId: listRuns
      summary: List runs
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      operationId: createRun
      summary: Create and start a run
      description: |
        Starts a run. For single-video URLs, the API is cache-first:
        if outputs already exist and `force` is false, the API returns a `done` run immediately (no transcription).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunCreateResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /runs/plan:
    post:
      operationId: planRun
      summary: Plan a run (enumerate + skip counts, no transcription)
      description: |
        Enumerates the input URL and computes how many videos are already processed vs remaining,
        without downloading audio or calling the transcription provider.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunCreateRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunPlanResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /runs/{runId}:
    get:
      operationId: getRun
      summary: Get a run
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunGetResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /runs/{runId}/logs:
    get:
      operationId: getRunLogs
      summary: Get recent run events as JSON (tail)
      description: |
        Returns the most recent buffered run events as JSON.
        This is a convenience endpoint for debugging without SSE; it is not guaranteed to return the full history.
      parameters:
        - $ref: "#/components/parameters/RunId"
        - name: tail
          in: query
          required: false
          schema: { type: integer }
          description: Max events to return (default 200, max 2000).
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [run, events]
                properties:
                  run: { $ref: "#/components/schemas/RunRecord" }
                  events:
                    type: array
                    items:
                      type: object
                      required: [id, event]
                      properties:
                        id: { type: integer }
                        event: { $ref: "#/components/schemas/PipelineEvent" }
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /runs/{runId}/cancel:
    post:
      operationId: cancelRun
      summary: Request cancellation of a run
      description: |
        Cooperative cancellation. If the run is running, the pipeline stops starting new work and ends as soon as practical.
        In-flight video work may finish. Queued runs are cancelled immediately.
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunGetResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"

  /runs/{runId}/artifacts:
    get:
      operationId: getRunArtifacts
      summary: Get artifacts for a run (channel videos listing)
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunArtifactsResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /runs/{runId}/events:
    get:
      operationId: streamRunEvents
      summary: Stream run events (SSE)
      description: |
        Server-Sent Events stream. Event names include:
        - run:start, run:done, run:cancelled, run:error
        - video:start, video:stage, video:done, video:skip, video:error
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /library/channels:
    get:
      operationId: listLibraryChannels
      summary: List channels from output directory
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChannelsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /library/channels/{channelDirName}:
    get:
      operationId: getLibraryChannelMeta
      summary: Get channel metadata
      parameters:
        - $ref: "#/components/parameters/ChannelDirName"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChannelMetaResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /library/channels/{channelDirName}/videos:
    get:
      operationId: listLibraryVideos
      summary: List videos for a channel
      parameters:
        - $ref: "#/components/parameters/ChannelDirName"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VideosResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /library/channels/{channelDirName}/videos/{basename}/{kind}:
    get:
      operationId: getLibraryVideoArtifact
      summary: Fetch a specific video artifact
      parameters:
        - $ref: "#/components/parameters/ChannelDirName"
        - $ref: "#/components/parameters/Basename"
        - $ref: "#/components/parameters/ArtifactKind"
      responses:
        "200":
          description: OK
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Required for all endpoints except `/health` (configured by server env `Y2T_API_KEY`).
  parameters:
    RunId:
      name: runId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    ChannelDirName:
      name: channelDirName
      in: path
      required: true
      schema:
        type: string
    Basename:
      name: basename
      in: path
      required: true
      schema:
        type: string
    ArtifactKind:
      name: kind
      in: path
      required: true
      schema:
        $ref: "#/components/schemas/ArtifactKind"

  responses:
    RateLimited:
      description: Rate limit exceeded
      headers:
        Retry-After:
          description: Seconds until the rate limit window resets
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
        message:
          type: string

    OkResponse:
      type: object
      required: [ok]
      properties:
        ok: { type: boolean }

    PipelineEvent:
      type: object
      description: |
        Best-effort schema for pipeline events (SSE and persisted events).
        This is intentionally loose because the event payload varies by `type`.
      required: [type]
      properties:
        type:
          type: string
          description: |
            Event type, e.g. `run:start`, `run:done`, `run:cancelled`, `run:error`,
            `video:start`, `video:stage`, `video:done`, `video:skip`, `video:error`.
      additionalProperties: true

    CleanupResponse:
      type: object
      required: [retention]
      properties:
        retention:
          type: object
          required: [nowIso, runs, audio]
          properties:
            nowIso: { type: string }
            runs:
              type: object
              required: [enabled, days, deleted, kept, errors]
              properties:
                enabled: { type: boolean }
                days: { type: integer }
                deleted: { type: integer }
                kept: { type: integer }
                errors: { type: integer }
            audio:
              type: object
              required: [enabled, days, deletedFiles, keptFiles, errors]
              properties:
                enabled: { type: boolean }
                days: { type: integer }
                deletedFiles: { type: integer }
                keptFiles: { type: integer }
                errors: { type: integer }

    NonSecretSettings:
      type: object
      description: |
        Persisted non-secret defaults. Secrets (API keys) are never stored here.
      properties:
        filenameStyle:
          type: string
          enum: [id, id_title, title_id]
        audioFormat:
          type: string
          enum: [mp3, wav]
        sttProvider:
          type: string
          enum: [assemblyai]
        languageDetection:
          type: string
          enum: [auto, manual]
        languageCode: { type: string }
        concurrency: { type: integer }
        maxNewVideos: { type: integer }
        afterDate: { type: string }
        csvEnabled: { type: boolean }
        commentsEnabled: { type: boolean }
        commentsMax: { type: integer }
        pollIntervalMs: { type: integer }
        maxPollMinutes: { type: integer }
        downloadRetries: { type: integer }
        transcriptionRetries: { type: integer }
        catalogMaxAgeHours: { type: integer }
      additionalProperties: false

    SettingsGetResponse:
      type: object
      required: [outputDir, settingsPath, settings, effective, sources]
      properties:
        outputDir: { type: string }
        settingsPath: { type: string }
        updatedAt: { type: string }
        settings:
          $ref: "#/components/schemas/NonSecretSettings"
        effective:
          $ref: "#/components/schemas/NonSecretSettings"
        sources:
          type: object
          additionalProperties: false
          properties:
            filenameStyle: { $ref: "#/components/schemas/NonSecretSettingSource" }
            audioFormat: { $ref: "#/components/schemas/NonSecretSettingSource" }
            sttProvider: { $ref: "#/components/schemas/NonSecretSettingSource" }
            languageDetection: { $ref: "#/components/schemas/NonSecretSettingSource" }
            languageCode: { $ref: "#/components/schemas/NonSecretSettingSource" }
            concurrency: { $ref: "#/components/schemas/NonSecretSettingSource" }
            maxNewVideos: { $ref: "#/components/schemas/NonSecretSettingSource" }
            afterDate: { $ref: "#/components/schemas/NonSecretSettingSource" }
            csvEnabled: { $ref: "#/components/schemas/NonSecretSettingSource" }
            commentsEnabled: { $ref: "#/components/schemas/NonSecretSettingSource" }
            commentsMax: { $ref: "#/components/schemas/NonSecretSettingSource" }
            pollIntervalMs: { $ref: "#/components/schemas/NonSecretSettingSource" }
            maxPollMinutes: { $ref: "#/components/schemas/NonSecretSettingSource" }
            downloadRetries: { $ref: "#/components/schemas/NonSecretSettingSource" }
            transcriptionRetries: { $ref: "#/components/schemas/NonSecretSettingSource" }
            catalogMaxAgeHours: { $ref: "#/components/schemas/NonSecretSettingSource" }

    NonSecretSettingSource:
      type: string
      enum: [env, config.yaml, settingsFile, default, unset]

    SettingsPatchRequest:
      type: object
      required: [settings]
      properties:
        settings:
          type: object
          description: |
            Partial settings update. Send `null` to clear a key.
          additionalProperties: false
          properties:
            filenameStyle: { type: [string, "null"], enum: [id, id_title, title_id, null] }
            audioFormat: { type: [string, "null"], enum: [mp3, wav, null] }
            sttProvider: { type: [string, "null"], enum: [assemblyai, null] }
            languageDetection: { type: [string, "null"], enum: [auto, manual, null] }
            languageCode: { type: [string, "null"] }
            concurrency: { type: [integer, "null"] }
            maxNewVideos: { type: [integer, "null"] }
            afterDate: { type: [string, "null"] }
            csvEnabled: { type: [boolean, "null"] }
            commentsEnabled: { type: [boolean, "null"] }
            commentsMax: { type: [integer, "null"] }
            pollIntervalMs: { type: [integer, "null"] }
            maxPollMinutes: { type: [integer, "null"] }
            downloadRetries: { type: [integer, "null"] }
            transcriptionRetries: { type: [integer, "null"] }
            catalogMaxAgeHours: { type: [integer, "null"] }
      additionalProperties: false

    WatchlistEntry:
      type: object
      required: [id, channelUrl, enabled, createdAt]
      properties:
        id: { type: string }
        channelUrl: { type: string }
        channelId: { type: string }
        channelTitle: { type: string }
        intervalMinutes: { type: integer }
        enabled: { type: boolean }
        lastCheckedAt: { type: string }
        lastRunId: { type: string }
        createdAt: { type: string }

    WatchlistCreateRequest:
      type: object
      required: [channelUrl]
      properties:
        channelUrl:
          type: string
          description: YouTube channel or playlist URL (watchlist is for recurring sources, not single videos).
        intervalMinutes: { type: [integer, "null"] }
        enabled: { type: boolean }

    WatchlistUpdateRequest:
      type: object
      properties:
        intervalMinutes:
          description: Optional. Set to null to clear override and use the scheduler global default.
          type: [integer, "null"]
        enabled: { type: boolean }

    WatchlistEntryResponse:
      type: object
      required: [entry]
      properties:
        entry:
          $ref: "#/components/schemas/WatchlistEntry"

    WatchlistListResponse:
      type: object
      required: [entries]
      properties:
        entries:
          type: array
          items:
            $ref: "#/components/schemas/WatchlistEntry"

    SchedulerStatus:
      type: object
      required: [enabled, running, intervalMinutes, maxConcurrentRuns]
      properties:
        enabled: { type: boolean }
        running: { type: boolean }
        intervalMinutes: { type: integer }
        maxConcurrentRuns: { type: integer }
        lastTickAt: { type: string }
        nextTickAt: { type: string }

    SchedulerStatusResponse:
      type: object
      required: [status]
      properties:
        status:
          $ref: "#/components/schemas/SchedulerStatus"

    SchedulerTriggerResponse:
      type: object
      required: [result, status]
      properties:
        result:
          type: object
          required: [checked, runsCreated]
          properties:
            checked: { type: integer }
            runsCreated: { type: integer }
        status:
          $ref: "#/components/schemas/SchedulerStatus"

    HealthResponse:
      type: object
      required: [ok, service]
      properties:
        ok:
          type: boolean
        service:
          type: string
        version:
          type: string
        deps:
          type: object
          properties:
            ytDlp:
              type: object
              required: [ok]
              properties:
                ok: { type: boolean }
                version: { type: string }
                error: { type: string }
            ffmpeg:
              type: object
              required: [ok]
              properties:
                ok: { type: boolean }
                error: { type: string }
            disk:
              type: object
              required: [ok]
              properties:
                ok: { type: boolean }
                freeBytes: { type: number }
                freeGb: { type: number }
                error: { type: string }
            persist:
              type: object
              required: [ok, dir, writable]
              properties:
                ok: { type: boolean }
                dir: { type: string }
                writable: { type: boolean }
                error: { type: string }

    RunStatus:
      type: string
      enum: [queued, running, done, error, cancelled]

    RunStats:
      type: object
      required: [succeeded, failed, skipped, total]
      properties:
        succeeded: { type: integer }
        failed: { type: integer }
        skipped: { type: integer }
        total: { type: integer }

    RunRecord:
      type: object
      required: [runId, status, inputUrl, force, createdAt]
      properties:
        runId: { type: string, format: uuid }
        status: { $ref: "#/components/schemas/RunStatus" }
        inputUrl: { type: string }
        force: { type: boolean }
        createdAt: { type: string }
        startedAt: { type: string }
        finishedAt: { type: string }
        cancelRequested: { type: boolean }
        error: { type: string }
        callbackUrl: { type: string }
        channelId: { type: string }
        channelTitle: { type: string }
        channelDirName: { type: string }
        previewVideoId: { type: string }
        previewTitle: { type: string }
        stats: { $ref: "#/components/schemas/RunStats" }

    RunsResponse:
      type: object
      required: [runs]
      properties:
        runs:
          type: array
          items: { $ref: "#/components/schemas/RunRecord" }

    RunGetResponse:
      type: object
      required: [run]
      properties:
        run: { $ref: "#/components/schemas/RunRecord" }

    RunCreateRequest:
      type: object
      required: [url]
      properties:
        url: { type: string }
        force: { type: [boolean, "null"] }
        maxNewVideos:
          type: [integer, "null"]
          description: |
            Limit this run to at most N NEW (unprocessed) videos.
            Applied AFTER skipping already-processed videos so repeated runs can backfill incrementally.
        afterDate:
          type: [string, "null"]
          description: Only include videos after YYYY-MM-DD (best-effort; based on yt-dlp upload_date).
        callbackUrl:
          type: [string, "null"]
          description: |
            Optional. If set, the API sends a POST webhook when the run ends:
            - `run:done` when status becomes done
            - `run:error` when status becomes error
            - `run:cancelled` when status becomes cancelled
            If `Y2T_WEBHOOK_SECRET` is set on the server, requests include:
            - `X-Y2T-Timestamp` (ISO)
            - `X-Y2T-Signature` (HMAC-SHA256 of `${timestamp}.${body}`)
        config:
          type: object
          additionalProperties: true

    RunCreateLinks:
      type: object
      required: [run, events, artifacts, cancel]
      properties:
        run: { type: string }
        events: { type: string }
        artifacts: { type: string }
        cancel: { type: string }

    RunCreateResponse:
      type: object
      required: [run, links]
      properties:
        run: { $ref: "#/components/schemas/RunRecord" }
        links: { $ref: "#/components/schemas/RunCreateLinks" }

    PlannedVideo:
      type: object
      required: [id, title, url, basename, processed]
      properties:
        id: { type: string }
        title: { type: string }
        url: { type: string }
        uploadDate: { type: string }
        basename: { type: string }
        processed: { type: boolean }

    RunPlan:
      type: object
      required:
        [
          inputUrl,
          force,
          channelId,
          totalVideos,
          alreadyProcessed,
          unprocessed,
          toProcess,
          filters,
          videos,
          selectedVideos
        ]
      properties:
        inputUrl: { type: string }
        force: { type: boolean }
        channelId: { type: string }
        channelTitle: { type: string }
        totalVideos: { type: integer }
        alreadyProcessed: { type: integer }
        unprocessed:
          type: integer
          description: Total unprocessed videos under the given filters (may be larger than `toProcess` when `maxNewVideos` is set).
        toProcess: { type: integer }
        filters:
          type: object
          required: []
          properties:
            afterDate: { type: string }
            maxNewVideos: { type: integer }
        videos:
          type: array
          items: { $ref: "#/components/schemas/PlannedVideo" }
        selectedVideos:
          type: array
          description: Videos selected to be processed for this run (unprocessed + capped by `maxNewVideos`).
          items: { $ref: "#/components/schemas/PlannedVideo" }

    RunPlanResponse:
      type: object
      required: [plan]
      properties:
        plan: { $ref: "#/components/schemas/RunPlan" }

    ChannelInfo:
      type: object
      required: [channelId, channelDirName]
      properties:
        channelId: { type: string }
        channelTitle: { type: string }
        channelDirName: { type: string }
        channelThumbnailUrl: { type: string }
        metaPath: { type: string }

    ChannelsResponse:
      type: object
      required: [channels]
      properties:
        channels:
          type: array
          items: { $ref: "#/components/schemas/ChannelInfo" }

    ChannelMeta:
      type: object
      required: [channelId, channelTitle, channelUrl]
      properties:
        channelId: { type: string }
        channelTitle: { type: string }
        channelUrl: { type: string }
        retrievedAt: { type: string }

    ChannelMetaResponse:
      type: object
      required: [channelDirName, meta]
      properties:
        channelDirName: { type: string }
        meta: { $ref: "#/components/schemas/ChannelMeta" }

    OutputPaths:
      type: object
      required:
        [
          jsonPath,
          txtPath,
          mdPath,
          jsonlPath,
          csvPath,
          commentsPath,
          metaPath,
          channelMetaPath,
          errorLogPath,
          audioPath
        ]
      properties:
        jsonPath: { type: string }
        txtPath: { type: string }
        mdPath: { type: string }
        jsonlPath: { type: string }
        csvPath: { type: string }
        commentsPath: { type: string }
        metaPath: { type: string }
        channelMetaPath: { type: string }
        errorLogPath: { type: string }
        audioPath: { type: string }

    VideoMeta:
      type: object
      required: [videoId]
      properties:
        videoId: { type: string }
        title: { type: string }
        channelId: { type: string }
        channelTitle: { type: string }
        channelUrl: { type: string }
        videoUrl: { type: string }
        description: { type: string }
        publishedAt: { type: string }
        languageCode: { type: string }
        languageDetection: { type: string }
        languageConfidence: { type: number }

    VideoInfo:
      type: object
      required: [videoId, basename, paths]
      properties:
        videoId: { type: string }
        title: { type: string }
        basename: { type: string }
        metaPath: { type: string }
        paths: { $ref: "#/components/schemas/OutputPaths" }
        meta: { $ref: "#/components/schemas/VideoMeta" }

    VideosResponse:
      type: object
      required: [channelDirName, videos]
      properties:
        channelDirName: { type: string }
        videos:
          type: array
          items: { $ref: "#/components/schemas/VideoInfo" }

    ArtifactKind:
      type: string
      enum: [txt, md, json, jsonl, meta, comments, csv, audio]

    RunArtifacts:
      type: object
      required: [videos]
      properties:
        channelDirName: { type: string }
        channelId: { type: string }
        channelTitle: { type: string }
        videos:
          type: array
          items: { $ref: "#/components/schemas/VideoInfo" }

    RunArtifactsResponse:
      type: object
      required: [run, artifacts]
      properties:
        run: { $ref: "#/components/schemas/RunRecord" }
        artifacts: { $ref: "#/components/schemas/RunArtifacts" }
