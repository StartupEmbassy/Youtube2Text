openapi: 3.1.0
info:
  title: Youtube2Text API
  version: 0.9.6
  description: |
    Minimal local HTTP API for Youtube2Text.
    Notes:
    - CLI remains the primary workflow; API/Web are shells around the same core.
    - SSE endpoints are documented as text/event-stream.
servers:
  - url: http://127.0.0.1:8787
security:
  - ApiKeyAuth: []
paths:
  /maintenance/cleanup:
    post:
      summary: Trigger retention cleanup (runs + audio cache)
      description: |
        Runs best-effort retention cleanup based on environment configuration.
        Notes:
        - Never deletes transcripts under `output/<channelDir>/...`.
        - Deletes only API run persistence under `output/_runs/*` (if enabled) and old audio cache files under `audio/*`.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CleanupResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events:
    get:
      summary: Stream global events (SSE)
      description: |
        Server-Sent Events stream for global run updates. Event names include:
        - run:created
        - run:updated
        Data is JSON matching the GlobalRunEvent schema.
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string

  /health:
    get:
      summary: Health check
      security: []
      parameters:
        - name: deep
          in: query
          required: false
          schema: { type: boolean }
          description: When true, returns a best-effort deep health check (deps + disk + persistence).
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /runs:
    get:
      summary: List runs
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunsResponse"
    post:
      summary: Create and start a run
      description: |
        Starts a run. For single-video URLs, the API is cache-first:
        if outputs already exist and `force` is false, the API returns a `done` run immediately (no transcription).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunCreateRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunCreateResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /runs/plan:
    post:
      summary: Plan a run (enumerate + skip counts, no transcription)
      description: |
        Enumerates the input URL and computes how many videos are already processed vs remaining,
        without downloading audio or calling the transcription provider.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RunCreateRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunPlanResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /runs/{runId}:
    get:
      summary: Get a run
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunGetResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /runs/{runId}/artifacts:
    get:
      summary: Get artifacts for a run (channel videos listing)
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunArtifactsResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /runs/{runId}/events:
    get:
      summary: Stream run events (SSE)
      description: |
        Server-Sent Events stream. Event names include:
        - run:start, run:done, run:error
        - video:start, video:stage, video:done, video:skip, video:error
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string

  /library/channels:
    get:
      summary: List channels from output directory
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChannelsResponse"

  /library/channels/{channelDirName}:
    get:
      summary: Get channel metadata
      parameters:
        - $ref: "#/components/parameters/ChannelDirName"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChannelMetaResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /library/channels/{channelDirName}/videos:
    get:
      summary: List videos for a channel
      parameters:
        - $ref: "#/components/parameters/ChannelDirName"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VideosResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /library/channels/{channelDirName}/videos/{basename}/{kind}:
    get:
      summary: Fetch a specific video artifact
      parameters:
        - $ref: "#/components/parameters/ChannelDirName"
        - $ref: "#/components/parameters/Basename"
        - $ref: "#/components/parameters/ArtifactKind"
      responses:
        "200":
          description: OK
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Optional when `Y2T_API_KEY` is unset. If `Y2T_API_KEY` is set on the server,
        all endpoints require this header (except `/health`).
  parameters:
    RunId:
      name: runId
      in: path
      required: true
      schema:
        type: string
        format: uuid
    ChannelDirName:
      name: channelDirName
      in: path
      required: true
      schema:
        type: string
    Basename:
      name: basename
      in: path
      required: true
      schema:
        type: string
    ArtifactKind:
      name: kind
      in: path
      required: true
      schema:
        $ref: "#/components/schemas/ArtifactKind"

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
        message:
          type: string

    CleanupResponse:
      type: object
      required: [retention]
      properties:
        retention:
          type: object
          required: [nowIso, runs, audio]
          properties:
            nowIso: { type: string }
            runs:
              type: object
              required: [enabled, days, deleted, kept, errors]
              properties:
                enabled: { type: boolean }
                days: { type: integer }
                deleted: { type: integer }
                kept: { type: integer }
                errors: { type: integer }
            audio:
              type: object
              required: [enabled, days, deletedFiles, keptFiles, errors]
              properties:
                enabled: { type: boolean }
                days: { type: integer }
                deletedFiles: { type: integer }
                keptFiles: { type: integer }
                errors: { type: integer }

    HealthResponse:
      type: object
      required: [ok, service]
      properties:
        ok:
          type: boolean
        service:
          type: string
        version:
          type: string
        deps:
          type: object
          properties:
            ytDlp:
              type: object
              required: [ok]
              properties:
                ok: { type: boolean }
                version: { type: string }
                error: { type: string }
            ffmpeg:
              type: object
              required: [ok]
              properties:
                ok: { type: boolean }
                error: { type: string }
            disk:
              type: object
              required: [ok]
              properties:
                ok: { type: boolean }
                freeBytes: { type: number }
                freeGb: { type: number }
                error: { type: string }
            persist:
              type: object
              required: [ok, dir, writable]
              properties:
                ok: { type: boolean }
                dir: { type: string }
                writable: { type: boolean }
                error: { type: string }

    RunStatus:
      type: string
      enum: [queued, running, done, error]

    RunStats:
      type: object
      required: [succeeded, failed, skipped, total]
      properties:
        succeeded: { type: integer }
        failed: { type: integer }
        skipped: { type: integer }
        total: { type: integer }

    RunRecord:
      type: object
      required: [runId, status, inputUrl, force, createdAt]
      properties:
        runId: { type: string, format: uuid }
        status: { $ref: "#/components/schemas/RunStatus" }
        inputUrl: { type: string }
        force: { type: boolean }
        createdAt: { type: string }
        startedAt: { type: string }
        finishedAt: { type: string }
        error: { type: string }
        callbackUrl: { type: string }
        channelId: { type: string }
        channelTitle: { type: string }
        channelDirName: { type: string }
        previewVideoId: { type: string }
        previewTitle: { type: string }
        stats: { $ref: "#/components/schemas/RunStats" }

    RunsResponse:
      type: object
      required: [runs]
      properties:
        runs:
          type: array
          items: { $ref: "#/components/schemas/RunRecord" }

    RunGetResponse:
      type: object
      required: [run]
      properties:
        run: { $ref: "#/components/schemas/RunRecord" }

    RunCreateRequest:
      type: object
      required: [url]
      properties:
        url: { type: string }
        force: { type: boolean }
        callbackUrl:
          type: string
          description: |
            Optional. If set, the API sends a POST webhook when the run ends:
            - `run:done` when status becomes done
            - `run:error` when status becomes error
            If `Y2T_WEBHOOK_SECRET` is set on the server, requests include:
            - `X-Y2T-Timestamp` (ISO)
            - `X-Y2T-Signature` (HMAC-SHA256 of `${timestamp}.${body}`)
        config:
          type: object
          additionalProperties: true

    RunCreateLinks:
      type: object
      required: [run, events, artifacts]
      properties:
        run: { type: string }
        events: { type: string }
        artifacts: { type: string }

    RunCreateResponse:
      type: object
      required: [run, links]
      properties:
        run: { $ref: "#/components/schemas/RunRecord" }
        links: { $ref: "#/components/schemas/RunCreateLinks" }

    PlannedVideo:
      type: object
      required: [id, title, url, basename, processed]
      properties:
        id: { type: string }
        title: { type: string }
        url: { type: string }
        uploadDate: { type: string }
        basename: { type: string }
        processed: { type: boolean }

    RunPlan:
      type: object
      required:
        [
          inputUrl,
          force,
          channelId,
          totalVideos,
          alreadyProcessed,
          toProcess,
          filters,
          videos
        ]
      properties:
        inputUrl: { type: string }
        force: { type: boolean }
        channelId: { type: string }
        channelTitle: { type: string }
        totalVideos: { type: integer }
        alreadyProcessed: { type: integer }
        toProcess: { type: integer }
        filters:
          type: object
          required: []
          properties:
            afterDate: { type: string }
            maxVideos: { type: integer }
        videos:
          type: array
          items: { $ref: "#/components/schemas/PlannedVideo" }

    RunPlanResponse:
      type: object
      required: [plan]
      properties:
        plan: { $ref: "#/components/schemas/RunPlan" }

    ChannelInfo:
      type: object
      required: [channelId, channelDirName]
      properties:
        channelId: { type: string }
        channelTitle: { type: string }
        channelDirName: { type: string }
        channelThumbnailUrl: { type: string }
        metaPath: { type: string }

    ChannelsResponse:
      type: object
      required: [channels]
      properties:
        channels:
          type: array
          items: { $ref: "#/components/schemas/ChannelInfo" }

    ChannelMeta:
      type: object
      required: [channelId, channelTitle, channelUrl]
      properties:
        channelId: { type: string }
        channelTitle: { type: string }
        channelUrl: { type: string }
        retrievedAt: { type: string }

    ChannelMetaResponse:
      type: object
      required: [channelDirName, meta]
      properties:
        channelDirName: { type: string }
        meta: { $ref: "#/components/schemas/ChannelMeta" }

    OutputPaths:
      type: object
      required:
        [
          jsonPath,
          txtPath,
          mdPath,
          jsonlPath,
          csvPath,
          commentsPath,
          metaPath,
          channelMetaPath,
          errorLogPath,
          audioPath
        ]
      properties:
        jsonPath: { type: string }
        txtPath: { type: string }
        mdPath: { type: string }
        jsonlPath: { type: string }
        csvPath: { type: string }
        commentsPath: { type: string }
        metaPath: { type: string }
        channelMetaPath: { type: string }
        errorLogPath: { type: string }
        audioPath: { type: string }

    VideoMeta:
      type: object
      required: [videoId]
      properties:
        videoId: { type: string }
        title: { type: string }
        channelId: { type: string }
        channelTitle: { type: string }
        channelUrl: { type: string }
        videoUrl: { type: string }
        description: { type: string }
        publishedAt: { type: string }
        languageCode: { type: string }
        languageDetection: { type: string }
        languageConfidence: { type: number }

    VideoInfo:
      type: object
      required: [videoId, basename, paths]
      properties:
        videoId: { type: string }
        title: { type: string }
        basename: { type: string }
        metaPath: { type: string }
        paths: { $ref: "#/components/schemas/OutputPaths" }
        meta: { $ref: "#/components/schemas/VideoMeta" }

    VideosResponse:
      type: object
      required: [channelDirName, videos]
      properties:
        channelDirName: { type: string }
        videos:
          type: array
          items: { $ref: "#/components/schemas/VideoInfo" }

    ArtifactKind:
      type: string
      enum: [txt, md, json, jsonl, meta, comments, csv, audio]

    RunArtifacts:
      type: object
      required: [videos]
      properties:
        channelDirName: { type: string }
        channelId: { type: string }
        channelTitle: { type: string }
        videos:
          type: array
          items: { $ref: "#/components/schemas/VideoInfo" }

    RunArtifactsResponse:
      type: object
      required: [run, artifacts]
      properties:
        run: { $ref: "#/components/schemas/RunRecord" }
        artifacts: { $ref: "#/components/schemas/RunArtifacts" }

    GlobalRunEventType:
      type: string
      enum: [run:created, run:updated]

    GlobalRunEvent:
      type: object
      required: [type, run, timestamp]
      properties:
        type: { $ref: "#/components/schemas/GlobalRunEventType" }
        run: { $ref: "#/components/schemas/RunRecord" }
        timestamp: { type: string }
